---
import fs from "fs";
import path from "path";
import BaseLayout from "../layouts/BaseLayout.astro";
import site from "../config/site.json";

// üß© Block imports
import ArticleItem from "../components/molecules/ArticleItem.astro";
import ArticlePreview from "../components/organisms/ArticlePreview.astro";
import Card from "../components/molecules/Card.astro";
import ContactInfo from "../components/organisms/ContactInfo.astro";
import ButtonBlock from "../components/molecules/ButtonBlock.astro";
import GalleryItem from "../components/molecules/GalleryItem.astro";
import GalleryPreview from "../components/organisms/GalleryPreview.astro";
import Hero from "../components/organisms/Hero.astro";
import LittleHero from "../components/organisms/LittleHero.astro";
import LogoHero from "../components/organisms/LogoHero.astro";
import MarkdownSection from "../components/organisms/MarkdownSection.astro";
import Section from "../components/organisms/Section.astro";
import SectionTitle from "../components/organisms/SectionTitle.astro";
import TextImageSection from "../components/organisms/TextImageSection.astro";
import UnknownBlock from "../components/atoms/UnknownBlock.astro";

// üîó Block name mapping
const components = {
  articleitem: ArticleItem,
  articlepreview: ArticlePreview,
  card: Card,
  contactinfo: ContactInfo,
  buttonblock: ButtonBlock,
  galleryitem: GalleryItem,
  gallerypreview: GalleryPreview,
  hero: Hero,
  littlehero: LittleHero,
  logohero: LogoHero,
  markdownsection: MarkdownSection,
  section: Section,
  sectiontitle: SectionTitle,
  textimagesection: TextImageSection,
};

// Helper for getting a component
function getComponent(block) {
  const name = (block.name || block.type || "").toLowerCase();
  return components[name] || UnknownBlock;
}

// ----------------------------
// getStaticPaths - all JSON files in pages
// ----------------------------
export async function getStaticPaths() {
  const pagesDir = path.resolve("./src/content/pages");
  const files = fs.readdirSync(pagesDir).filter(f => f.endsWith(".json"));

  return files.map(file => {
    const slug = file.replace(".json", "");
    return { params: { slug } };
  });
}

// ----------------------------
// Getting slug from URL, fallback to "index"
// ----------------------------
const slug = Astro.params.slug || "index";
const pagePath = path.resolve(`./src/content/pages/${slug}.json`);

let page = null;
try {
  page = JSON.parse(fs.readFileSync(pagePath, "utf-8"));
} catch (e) {
  console.warn(`‚ö†Ô∏è The JSON file for slug "${slug}" does not exist. I am using fallback.`);
  page = {
    title: "Page not found.",
    blocks: [
      {
        name: "sectiontitle",
        title: "Oops...",
        subtitle: `The page with URL "/${slug}" does not exist.`,
      },
    ],
  };
}
---
<BaseLayout title={page?.title || "Page"} site={site}>
  {page?.blocks && page.blocks.length > 0 ? (
    page.blocks.map((block) => {
      const Component = getComponent(block);
      // Original logic for other blocks
      const innerBlocks = block.blocks || [];
      return <Component {...block} blocks={innerBlocks} />;
    })
  ) : (
    <p class="text-center text-gray-500">No blocks to display.</p>
  )}
</BaseLayout>
